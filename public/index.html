<!doctype html>
<html lang="pt-BR" class="h-full bg-slate-950">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Construtor de Fluxo - ZapVoice</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>body { font-family: 'Inter', sans-serif; }</style>
</head>

<body class="text-slate-100 p-6 max-w-4xl mx-auto">
    
    <header class="flex justify-between items-center mb-8 border-b border-slate-800 pb-4">
        <div>
            <h1 class="text-2xl font-bold text-emerald-400">ZapVoice Builder ü§ñ</h1>
            <p class="text-slate-400 text-sm">Crie fluxos de conversa inteligentes</p>
        </div>
        <div class="flex items-center gap-3">
             <span id="statusBadge" class="px-3 py-1 rounded-full bg-rose-500/20 text-rose-300 text-xs font-bold border border-rose-500/30">OFFLINE</span>
             <img id="qrImg" class="w-10 h-10 hidden border rounded" />
        </div>
    </header>

    <main class="grid md:grid-cols-2 gap-8">
        
        <section class="bg-slate-900/50 p-6 rounded-2xl border border-slate-800">
            <h2 class="text-lg font-semibold mb-4 flex gap-2 items-center">
                <i data-lucide="plus-square"></i> Criar/Editar Bloco
            </h2>

            <form id="blockForm" class="space-y-4">
                
                <div>
                    <label class="text-xs text-slate-400 uppercase font-bold">Nome do Bloco (ID)</label>
                    <input type="text" id="blockId" placeholder="Ex: inicio" 
                        class="w-full bg-slate-950 border border-slate-800 rounded p-2 text-sm focus:border-emerald-500 outline-none" required>
                    <p class="text-[10px] text-slate-500 mt-1">Use 'inicio' para a primeira mensagem.</p>
                </div>

                <div>
                    <label class="text-xs text-slate-400 uppercase font-bold">Tipo de Resposta</label>
                    <select id="blockType" class="w-full bg-slate-950 border border-slate-800 rounded p-2 text-sm text-slate-300">
                        <option value="texto">Apenas Texto</option>
                        <option value="menu">Menu (Texto + Op√ß√µes)</option>
                        <option value="audio">√Åudio (Gravado na hora)</option>
                    </select>
                </div>

                <div>
                    <label class="text-xs text-slate-400 uppercase font-bold">Mensagem / Legenda</label>
                    <textarea id="blockText" rows="3" placeholder="Ol√°! Digite 1 para..." 
                        class="w-full bg-slate-950 border border-slate-800 rounded p-2 text-sm focus:border-emerald-500 outline-none"></textarea>
                </div>

                <div id="audioField" class="hidden">
                    <label class="text-xs text-slate-400 uppercase font-bold">Arquivo de √Åudio (.ogg/.mp3)</label>
                    <input type="file" id="blockFile" accept="audio/*" class="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-emerald-500/10 file:text-emerald-400 hover:file:bg-emerald-500/20"/>
                </div>

                <div id="optionsField" class="hidden border-t border-slate-800 pt-4">
                    <label class="text-xs text-emerald-400 uppercase font-bold mb-2 block">Caminhos (Roteamento)</label>
                    <div id="optionsList" class="space-y-2">
                        </div>
                    <button type="button" onclick="addOption()" class="mt-2 text-xs flex items-center gap-1 text-slate-400 hover:text-white">
                        <i data-lucide="plus-circle" class="w-3 h-3"></i> Adicionar Op√ß√£o
                    </button>
                </div>

                <button type="submit" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-3 rounded-lg transition shadow-lg shadow-emerald-900/20">
                    Salvar Bloco
                </button>
            </form>
        </section>

        <section class="bg-slate-900/50 p-6 rounded-2xl border border-slate-800 h-fit">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-semibold flex gap-2 items-center">
                    <i data-lucide="git-branch"></i> Seu Fluxo Atual
                </h2>
                <button onclick="resetFlow()" class="text-xs text-rose-400 hover:text-rose-300">Apagar Tudo</button>
            </div>
            
            <div id="flowMap" class="space-y-3 max-h-[600px] overflow-y-auto pr-2">
                <div class="text-center text-slate-600 py-10">Nenhum bloco criado. Comece criando o bloco 'inicio'.</div>
            </div>
        </section>

    </main>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let optionsCount = 0;

        // --- L√ìGICA DE INTERFACE ---
        
        // Mostrar campos baseados no tipo
        document.getElementById('blockType').addEventListener('change', (e) => {
            const type = e.target.value;
            document.getElementById('audioField').classList.toggle('hidden', type !== 'audio');
            // Menus precisam de op√ß√µes. Audio e texto simples geralmente encerram ou reiniciam
            document.getElementById('optionsField').classList.toggle('hidden', type === 'audio' || type === 'texto');
            if(type === 'menu') document.getElementById('optionsField').classList.remove('hidden');
        });

        // Adicionar campos de op√ß√£o dinamicamente
        function addOption() {
            const div = document.createElement('div');
            div.className = "flex gap-2";
            div.innerHTML = `
                <input type="text" placeholder="Se digitar..." class="w-1/3 bg-slate-950 border border-slate-700 rounded p-2 text-xs text-white opt-trigger">
                <input type="text" placeholder="Vai para o bloco..." class="w-2/3 bg-slate-950 border border-slate-700 rounded p-2 text-xs text-white opt-next">
                <button type="button" onclick="this.parentElement.remove()" class="text-rose-500 hover:text-rose-400"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
            `;
            document.getElementById('optionsList').appendChild(div);
            lucide.createIcons();
        }

        // --- COMUNICA√á√ÉO COM O SERVIDOR ---

        // 1. Salvar Bloco
        document.getElementById('blockForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData();
            formData.append('id', document.getElementById('blockId').value);
            formData.append('tipo', document.getElementById('blockType').value);
            formData.append('texto', document.getElementById('blockText').value);
            
            // Pega o √°udio se tiver
            const file = document.getElementById('blockFile').files[0];
            if(file) formData.append('midia', file);

            // Pega as op√ß√µes de roteamento
            const triggers = document.querySelectorAll('.opt-trigger');
            const nexts = document.querySelectorAll('.opt-next');
            const opcoes = [];
            triggers.forEach((t, index) => {
                if(t.value && nexts[index].value) {
                    opcoes.push({ gatilho: t.value, proximo: nexts[index].value });
                }
            });
            formData.append('opcoes', JSON.stringify(opcoes));

            await fetch('/api/salvar-bloco', { method: 'POST', body: formData });
            alert('Bloco salvo!');
            carregarFluxo();
            e.target.reset();
            document.getElementById('optionsList').innerHTML = '';
        });

        // 2. Carregar e Desenhar Fluxo
        async function carregarFluxo() {
            const res = await fetch('/api/fluxo');
            const fluxo = await res.json();
            const container = document.getElementById('flowMap');
            
            if(fluxo.length === 0) {
                container.innerHTML = "<div class='text-center text-slate-600 py-10'>Nenhum bloco criado.</div>";
                return;
            }

            container.innerHTML = fluxo.map(b => `
                <div class="bg-slate-800/40 p-4 rounded-xl border border-slate-700/50 relative group hover:border-emerald-500/50 transition">
                    <span class="absolute top-2 right-2 text-[10px] uppercase bg-slate-900 px-2 py-0.5 rounded text-slate-400 border border-slate-700">${b.tipo}</span>
                    <h3 class="font-bold text-emerald-400 text-sm mb-1">#${b.id}</h3>
                    <p class="text-xs text-slate-300 italic mb-3 truncate">"${b.texto.substring(0,50)}..."</p>
                    
                    ${b.opcoes && b.opcoes.length > 0 ? `
                        <div class="space-y-1">
                            ${b.opcoes.map(op => `
                                <div class="flex items-center text-[10px] gap-2">
                                    <span class="bg-slate-700 px-1.5 rounded text-white">${op.gatilho}</span>
                                    <i data-lucide="arrow-right" class="w-3 h-3 text-slate-500"></i>
                                    <span class="text-emerald-300 font-mono">#${op.proximo}</span>
                                </div>
                            `).join('')}
                        </div>
                    ` : '<span class="text-[10px] text-slate-500">Fim do fluxo ou espera resposta livre.</span>'}
                </div>
            `).join('');
            lucide.createIcons();
        }

        async function resetFlow() {
            if(confirm('Isso vai apagar todos os blocos. Continuar?')) {
                await fetch('/api/resetar', { method: 'POST' });
                carregarFluxo();
            }
        }

        // 3. Socket (QR Code e Status)
        socket.on('qr', (url) => {
            const img = document.getElementById('qrImg');
            img.src = url;
            img.classList.remove('hidden');
        });

        socket.on('status', (data) => {
            const badge = document.getElementById('statusBadge');
            const qr = document.getElementById('qrImg');
            if(data.online) {
                badge.innerText = "ONLINE";
                badge.className = "px-3 py-1 rounded-full bg-emerald-500/20 text-emerald-300 text-xs font-bold border border-emerald-500/30";
                qr.classList.add('hidden');
            } else {
                badge.innerText = "OFFLINE";
                badge.className = "px-3 py-1 rounded-full bg-rose-500/20 text-rose-300 text-xs font-bold border border-rose-500/30";
            }
        });

        // Init
        lucide.createIcons();
        carregarFluxo();
    </script>
</body>
</html>